<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket — MiCaja POS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">  
  <style>
    body{background:#fff;color:#000}
    .ticket{max-width:380px;margin:0 auto;padding:10px;font-family:monospace}
    hr{margin:8px 0}
    @media print {.no-print{display:none}}
  </style>
</head>
<body>
  <div class="ticket">
    <h6 class="text-center">MiCaja POS</h6>
    <div id="t-meta" class="small"></div>
    <hr>
    <div id="t-items"></div>
    <hr>
    <div class="d-flex justify-content-between"><span>Subtotal</span><strong id="t-sub"></strong></div>
    <div class="d-flex justify-content-between"><span>IVA 19%</span><strong id="t-iva"></strong></div>
    <div class="d-flex justify-content-between"><span>Total</span><strong id="t-total"></strong></div>
    <div class="text-center mt-2 no-print">
      <button class="btn btn-dark btn-sm" onclick="window.print()">Imprimir</button>
      <a class="btn btn-outline-secondary btn-sm" href="ventas.html">Volver</a>
    </div>
  </div>

  <script type="module">
    // Lee ID desde query (?id=) o del localStorage pos_last_sale_id
    const params = new URLSearchParams(location.search);
    const qId = params.get('id') || localStorage.getItem('pos_last_sale_id');

    async function getSale(id){
      if (!id) return null;
      // Preferir SDK si existe
      if (window.SDK?.Sales?.getOne) {
        try{
          const s = await window.SDK.Sales.getOne(id);
          if (s) return {
            id: s.id || id,
            ts: s.ts ? new Date(s.ts).getTime() : (s.date ? new Date(s.date).getTime() : Date.now()),
            items: (s.items||[]).map(it => ({
              name: it.name || it.nombre || '',
              price: Number(it.price || it.precio || 0),
              qty: Number(it.qty || it.quantity || 1)
            })),
            subtotal: Number(s.subtotal ?? 0),
            iva: Number(s.iva ?? s.tax ?? 0),
            total: Number(s.total ?? 0)
          };
        }catch(e){ console.warn(e); }
      }
      // Fallback: buscar en pos_sales
      try{
        const all = JSON.parse(localStorage.getItem('pos_sales')||'[]');
        const s = all.find(x => String(x.id) === String(id));
        if(!s) return null;
        return {
          id: s.id,
          ts: Number(s.ts || Date.now()),
          items: (s.items||[]).map(it => ({
            name: it.nombre || it.name || '',
            price: Number(it.precio || it.price || 0),
            qty: Number(it.qty || 1)
          })),
          subtotal: Number(s.subtotal || 0),
          iva: Number(s.iva || 0),
          total: Number(s.total || 0)
        };
      }catch{ return null; }
    }

    function render(sale){
      if(!sale){
        document.body.innerHTML = '<div class="ticket">No hay ticket.</div>';
        return;
      }
      document.getElementById('t-meta').textContent = `Folio: ${sale.id} · ${new Date(sale.ts).toLocaleString('es-CL')}`;
      document.getElementById('t-items').innerHTML = sale.items.map(i =>
        `<div class="d-flex justify-content-between">
          <span>${i.name} x${i.qty}</span><span>$${(i.price*i.qty).toLocaleString('es-CL')}</span>
        </div>`
      ).join('');
      document.getElementById('t-sub').textContent  = '$'+Number(sale.subtotal||0).toLocaleString('es-CL');
      document.getElementById('t-iva').textContent  = '$'+Number(sale.iva||0).toLocaleString('es-CL');
      document.getElementById('t-total').textContent= '$'+Number(sale.total||0).toLocaleString('es-CL');
    }

    (async ()=>{
      const sale = await getSale(qId);
      render(sale);
    })();
  </script>
</body>
</html>

