<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>POS – Cajero</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body class="bg-dark text-light">
  <nav class="navbar navbar-dark bg-black">
    <div class="container d-flex justify-content-between align-items-center">
      <span class="fw-bold">MiCaja POS</span>
      <div class="d-flex align-items-center gap-2">
        <span id="userBadge" class="badge text-bg-secondary">CAJERO</span>
        <button id="btnLogout" class="btn btn-outline-light btn-sm">Salir</button>
      </div>
    </div>
  </nav>

  <div class="container my-3">
    <div class="row g-3">
      <aside class="col-lg-3">
        <div class="sidebar p-3 card bg-black border-secondary">
          <div class="mb-2 fw-semibold">Caja</div>

          <button id="btnOpenCash"  class="btn btn-sm btn-outline-light w-100 text-start mb-1" type="button">Abrir caja</button>
          <button id="btnCloseCash" class="btn btn-sm btn-outline-light w-100 text-start"     type="button">Cerrar caja</button>

          <div class="small text-secondary mt-2" id="cashStatus">Caja: —</div>

          <hr>
          <div class="mb-2 fw-semibold">Venta</div>
          <a class="nav-link rounded px-2 py-1" href="#">Nueva venta</a>
          <a class="nav-link rounded px-2 py-1" href="#">Devolución</a>
          <hr>
          <div class="mb-2 fw-semibold">Consultas</div>
          <a class="nav-link rounded px-2 py-1" href="admin.html">Inventario</a>
        </div>
      </aside>

      <main class="col-lg-9">
        <div class="row g-3">
          <div class="col-lg-7">
            <div class="card p-3 bg-black border-secondary">
              <div class="input-group mb-2">
                <input id="q" class="form-control" placeholder="Buscar por nombre o código...">
                <button class="btn btn-info" id="btnBuscar">Buscar</button>
              </div>
              <div id="listaProductos" class="list-group list-group-flush"></div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="card p-3 bg-black border-secondary">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="m-0">Carrito</h5>
                <span class="text-muted small">Ctrl + P para ticket</span>
              </div>
              <div id="carrito" class="small mt-2"></div>
              <hr>
              <div class="d-flex justify-content-between"><span>Subtotal</span><strong id="subtotal">$0</strong></div>
              <div class="d-flex justify-content-between"><span>IVA (19%)</span><strong id="iva">$0</strong></div>
              <div class="d-flex justify-content-between fs-5"><span>Total</span><strong id="total">$0</strong></div>
              <button class="btn btn-info w-100 mt-2" id="btnCobrar">Cobrar</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- SDK -->
  <script src="assets/sdk.mock.js"></script>

  <!-- Módulos -->
  <script type="module">
    import { requireAuth, logout } from './js/auth.js';
    import { initPOS } from './js/pos.js';

    const u = requireAuth(['CAJERO']);
    if (u) {
      // pinta usuario y logout
      document.getElementById('btnLogout')?.addEventListener('click', logout);
      const badge = document.getElementById('userBadge');
      if (badge) badge.textContent = `${u.u} · ${u.rol}`;

      // refs
      const btnCobrar = document.querySelector('#btnCobrar');
      const lblStatus = document.querySelector('#cashStatus');
      const btnOpen   = document.querySelector('#btnOpenCash');
      const btnClose  = document.querySelector('#btnCloseCash');

      // estado caja
      async function refreshCashStatus(){
        const cur = await window.SDK.Cash.current();
        if (cur) {
          lblStatus.textContent = `Caja abierta por ${cur.user} desde ${new Date(cur.openTs).toLocaleString('es-CL')}`;
          btnCobrar?.removeAttribute('disabled');
        } else {
          lblStatus.textContent = 'Caja: cerrada';
          btnCobrar?.setAttribute('disabled','disabled');
        }
      }

      btnOpen?.addEventListener('click', async ()=>{
        const monto = Number(prompt('Monto de apertura (opcional):','0')) || 0;
        try{
          await window.SDK.Cash.open({ user: u.u, openingAmount: monto });
          await refreshCashStatus();
          alert('Caja abierta correctamente.');
        }catch(e){
          alert(e?.message || 'No se pudo abrir la caja.');
        }
      });

      btnClose?.addEventListener('click', async ()=>{
        const monto = Number(prompt('Monto de cierre (opcional):','0')) || 0;
        try{
          await window.SDK.Cash.close({ user: u.u, closingAmount: monto });
          await refreshCashStatus();
          alert('Caja cerrada correctamente.');
        }catch(e){
          alert(e?.message || 'No se pudo cerrar la caja.');
        }
      });

      // POS funcional
      initPOS({
        selectors: {
          q: '#q',
          list: '#listaProductos',
          cart: '#carrito',
          sub: '#subtotal',
          iva: '#iva',
          total: '#total',
          chargeBtn: '#btnCobrar'
        },
        user: u,
        goToTicket: 'ticket.html'
      });

      // buscar
      document.getElementById('btnBuscar')?.addEventListener('click', () => {
        document.getElementById('q')?.dispatchEvent(new Event('input'));
      });

      // al cargar
      refreshCashStatus();
    }
  </script>
</body>
</html>
